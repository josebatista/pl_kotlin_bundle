name: Release Backend

on:
  release:
    types: [published]

permissions:
  contents: read
  packages: write

env:
  IMAGE_REGISTRY: ghcr.io

jobs:
  build-and-push:
    name: Build (Gradle) → Build & Push Docker
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: ./backend/chirp
    if: startsWith(github.event.release.tag_name, 'backend_v')

    env:
      GRADLE_USER_HOME: /tmp/gradle-home

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Java 21
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: '21'
          cache: gradle

      - name: Install Node.js (act workaround)
        if: env.ACT == 'true'
        run: |
          apt-get update
          apt-get install -y nodejs npm
          node --version
          npm --version

      - name: Decode Firebase credentials
        run: |
          mkdir -p app/src/main/resources/firebase-credentials
          echo "${{ secrets.FIREBASE_SERVICE_ACCOUNT_BASE64 }}" | base64 -d \
            > app/src/main/resources/firebase-credentials/chirp-firebase-adminsdk.json

      - name: Build jar with Gradle
        id: gradle-build
        run: |
          chmod +x ./gradlew
          export ORG_GRADLE_JVMARGS="-Xms512m -Xmx2g -XX:MaxMetaspaceSize=512m -Dorg.gradle.instrumentation.agent=false"
          ./gradlew clean :app:bootJar --no-daemon --no-watch-fs
          JAR_PATH=$(ls app/build/libs/*.jar | head -n1)
          if [ -z "$JAR_PATH" ]; then
            echo "Jar not found in build/libs"
            exit 1
          fi
          JAR_NAME=$(basename "$JAR_PATH")
          echo "JAR_NAME=${JAR_NAME}" >> $GITHUB_OUTPUT
          echo "Found JAR: $JAR_NAME"

      - name: Login to GHCR
        uses: docker/login-action@v2
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Build and push image to GHCR
        id: buildpush
        uses: docker/build-push-action@v4
        with:
          context: ./backend/chirp
          file: ./backend/chirp/Dockerfile
          platforms: linux/arm64
          push: true
          tags: |
            ${{ env.IMAGE_REGISTRY }}/${{ secrets.GHCR_OWNER }}/${{ secrets.IMAGE_NAME }}:${{ github.event.release.tag_name }}
          build-args: |
            JAR_NAME=${{ steps.gradle-build.outputs.JAR_NAME }}

      - name: Cleanup Firebase credentials
        if: always()
        run: |
          rm -f app/src/main/resources/firebase-credentials/chirp-firebase-adminsdk.json
          
  deploy:
    name: Deploy via API
    runs-on: ubuntu-latest
    needs: build-and-push

    steps:
      - name: Install jq
        run: sudo apt-get update && sudo apt-get install -y jq

      - name: Update stack
        env:
          PORTAINER_URL: ${{ secrets.PORTAINER_URL }}
          PORTAINER_TOKEN: ${{ secrets.PORTAINER_API_TOKEN }}
          STACK_ID: ${{ secrets.PORTAINER_STACK_ID }}
          ENDPOINT_ID: ${{ secrets.PORTAINER_ENDPOINT_ID }}
          CF_ACCESS_CLIENT_ID: ${{ secrets.CF_ACCESS_CLIENT_ID }}
          CF_ACCESS_CLIENT_SECRET: ${{ secrets.CF_ACCESS_CLIENT_SECRET }}
          GHCR_OWNER: ${{ secrets.GHCR_OWNER }}
          IMAGE_NAME: ${{ secrets.IMAGE_NAME }}
          IMAGE_TAG: ${{ github.event.release.tag_name }}
        run: |
          set -Eeuo pipefail

          echo "::add-mask::$PORTAINER_TOKEN"
          echo "::add-mask::$CF_ACCESS_CLIENT_ID"
          echo "::add-mask::$CF_ACCESS_CLIENT_SECRET"

          echo "Fetching current stack definition..."

          STACK_JSON=$(curl -sS \
            -H "X-API-Key: $PORTAINER_TOKEN" \
            -H "CF-Access-Client-Id: $CF_ACCESS_CLIENT_ID" \
            -H "CF-Access-Client-Secret: $CF_ACCESS_CLIENT_SECRET" \
            "$PORTAINER_URL/api/stacks/$STACK_ID"
          )

          STACK_ENV=$(echo "$STACK_JSON" | jq '.Env')

          STACK_FILE=$(curl -sS \
            -H "X-API-Key: $PORTAINER_TOKEN" \
            -H "CF-Access-Client-Id: $CF_ACCESS_CLIENT_ID" \
            -H "CF-Access-Client-Secret: $CF_ACCESS_CLIENT_SECRET" \
            "$PORTAINER_URL/api/stacks/$STACK_ID/file"
          )

          COMPOSE=$(echo "$STACK_FILE" | jq -r '.StackFileContent')

          echo "Updating image tag to $IMAGE_TAG..."

          UPDATED=$(echo "$COMPOSE" | sed -E \
            "s|(image:\s*ghcr.io/${GHCR_OWNER}/${IMAGE_NAME}:)[^[:space:]]+|\1$IMAGE_TAG|"
          )

          echo "Deploying updated stack..."

          JSON_REQUEST=$(jq -n \
              --arg content "$UPDATED" \
              --argjson stack_env "$STACK_ENV" \
              '{env: $stack_env, stackFileContent: $content}'
          )

          HTTP_STATUS=$(curl -sS -o /dev/null -w "%{http_code}" -X PUT \
            -H "X-API-Key: $PORTAINER_TOKEN" \
            -H "CF-Access-Client-Id: $CF_ACCESS_CLIENT_ID" \
            -H "CF-Access-Client-Secret: $CF_ACCESS_CLIENT_SECRET" \
            -H "Content-Type: application/json" \
            "$PORTAINER_URL/api/stacks/$STACK_ID?endpointId=$ENDPOINT_ID" \
            -d "$JSON_REQUEST"
          )

          if [[ "$HTTP_STATUS" -lt 200 || "$HTTP_STATUS" -ge 300 ]]; then
            echo "❌ Deployment failed (HTTP $HTTP_STATUS)"
            exit 1
          fi
          
          echo "✅ Deployment triggered successfully (HTTP $HTTP_STATUS)"
